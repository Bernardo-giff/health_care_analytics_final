---
title: "Final assignment"
output: html_document
date: "2024-06-16"
---

# Introduction

Based on the article [Beautiful inside and out: Peer characteristics and academic performance](https://www.sciencedirect.com/science/article/pii/S0167268123004316?via%3Dihub), we propose a similar study where we investigate the relationship between attractiveness in adolescence and substance abuse later on. For that, we utilize data from waves 1 and 3.

In this file, we will focus on the code and statistical methods to produce the anaysis. This is also available in the remote repo: [git repo here](https://github.com/Bernardo-giff/health_care_analytics_final)

```{r}
# Set the working dir
setwd('/Users/bernardocarvalho/Library/CloudStorage/OneDrive-ImperialCollegeLondon/2024/Health care analytics')

# Get necessary libraries
library(dplyr)
library(stargazer)
library(stringr)
library(ggplot2)

```

# Importing data

In the table below we can see the the

![Diagram of the study's structure.](./images/study_diagram.png)

Download analysis [ready data here](https://www.icpsr.umich.edu/web/DSDR/studies/21600/versions/V25/download/rdata?path=/pcms/studies/0/2/1/6/21600/V25)

```{r}
# Set dir for the files
path = "ICPSR_21600/"

# Loading the dataset (in-home) for wave 1
load(paste0(path, "DS0001/21600-0001-Data.rda"))

# Loading the dataset (in-home) for wave 3
load(paste0(path, "DS0008/21600-0008-Data.rda"))

# Loading the dataset (grades) for wave 3
load(paste0(path, "DS0016/21600-0016-Data.rda"))


# Renaming the dataset
w1_data = da21600.0001

# Renaming the dataset
w3_data = da21600.0008

w3_acad = da21600.0016

# Removing the original uplaod
rm(da21600.0001)
# Removing the original uplaod
rm(da21600.0008)
# Removing the original uplaod
rm(da21600.0016)

# Finally, we create a dataset composed of the merged data from the two waves
data = merge(w1_data, w3_data, by = "AID")

data = merge(data, w3_acad, by = "AID")

# Removing w1 data
rm(w1_data)
# Removing w3 data
rm(w3_data)

```

For simplicity, we will also rename the variables that will be used in the regression

```{r}
# Rename columns using dplyr
data <- data %>%
  rename(
    w1_phi_attr = H1IR1,
    w1_per_attr = H1IR2,
    w1_phi_mat = H1IR5,
    w1_groom = H1IR3,
  )
```

# Data cleaning and EDA

# Regression

```{r}

ols = lm(EAOGPAC ~ w1_phi_attr + w1_per_attr + BIO_SEX, data=data[!is.na(data$EAOGPAC), ])

stargazer(ols, type='text')
```

Similar to the approach of the article, we try to simplify the attractiveness variable to a binary variable:

1 if scored attractive or very attractive. 0 otherwise

Hence:

```{r}

# Convert data to character
data$w1_per_attr <- as.character(data$w1_per_attr)

# Extract the second number in parentheses
data$w1_per_attr <- as.numeric(str_match(data$w1_per_attr, "\\((\\d+)\\)\\s*\\((\\d+)\\)")[, 3])

data$w1_per_attr_new <- ifelse(data$w1_per_attr %in% c(5, 6), 1, 0)

# Convert data to character
data$w1_phi_attr <- as.character(data$w1_phi_attr)

# Extract the second number in parentheses
data$w1_phi_attr <- as.numeric(str_match(data$w1_phi_attr, "\\((\\d+)\\)\\s*\\((\\d+)\\)")[, 3])

data$w1_phi_attr_new <- ifelse(data$w1_phi_attr %in% c(5, 6), 1, 0)

# Convert data to character
data$w1_phi_mat <- as.character(data$w1_phi_mat)

# Extract the second number in parentheses
data$w1_phi_mat <- as.numeric(str_match(data$w1_phi_mat, "\\((\\d+)\\)\\s*\\((\\d+)\\)")[, 3])

data$w1_phi_mat_new <- ifelse(data$w1_phi_mat %in% c(5, 6), 1, 0)

# Conver bio sex data to binary
data$male <- ifelse(data$BIO_SEX == '(1) (1) Male',1,0)

```

```{r}

data$log_EAOGPAC <- log(data$EAOGPAC)

ols = lm(EAOGPAC ~ w1_phi_attr_new*male + w1_per_attr_new*male + w1_phi_mat_new, data=data[!is.na(data$EAOGPAC), ])

stargazer(ols, type='text')
```

**Classes of interest**

Cleaning up the data

```{r}
# Convert factor to character
w1_data$H1GH59A <- as.character(w1_data$H1GH59A)
w1_data$H1GH59B <- as.character(w1_data$H1GH59B)

# Extract the second number in parentheses
w1_data$feet_value <- as.numeric(str_match(w1_data$H1GH59A, "\\((\\d+)\\)\\s*\\((\\d+)\\)")[, 3])
# Extract the second number in parentheses
w1_data$inch_value <- as.numeric(str_match(w1_data$H1GH59B, "\\((\\d+)\\)\\s*\\((\\d+)\\)")[, 3])

# Filter feet value for the acceptable range
w1_data <- w1_data[!is.na(w1_data$feet_value) & w1_data$feet_value >= 4 & w1_data$feet_value <= 7, ]

# Filter inch values for the acceptbale range
w1_data <- w1_data[!is.na(w1_data$inch_value) & w1_data$inch_value >= 0 & w1_data$inch_value <= 9, ]
```

```{r}

# Convert feet to centimeters (1 foot = 30.48 cm)
w1_data$feet_value_cm <- w1_data$feet_value * 30.48
# Convert feet to centimeters (1 inch = 2.54 cm)
w1_data$inch_value_cm <- w1_data$inch_value * 2.54

# Create height in cm column
w1_data$height_cm <- w1_data$feet_value_cm + w1_data$inch_value_cm

# View the data with the extracted and converted values
w1_data %>% select(c(H1GH59A, H1GH59B, feet_value_cm, inch_value_cm, height_cm))
```

### Finding patterns across generations

Show the distribution of the sleep data

```{r}
# For creating chart, we need to use ggplot() function and provide input data for each axes. Then we use geom_bar() function to apply bar chart specifications and labs() function to put labels on the chart. theme() function has been used to move the title to the center.
# Change line color and fill color
ggplot(w1_data, aes(x=H1GH51))+
  geom_histogram(color="darkblue", fill="lightblue")

```

Show the distribution of the height data

```{r}
ggplot(w1_data, aes(x=height_cm))+
  geom_histogram(color="darkblue", fill="lightblue")

```

Investigate weight distribution

```{r}
# Filter out data outside of the acceptable range

w1_data$weight_kg <- w1_data$H1GH60 * 0.453

ggplot(w1_data, aes(x=weight_kg))+
  geom_histogram(color="darkblue", fill="lightblue")

```

Investigate the BMI distribution

```{r}

w1_data$bmi <- w1_data$weight_kg / ((w1_data$height_cm/100)^2)

ggplot(w1_data, aes(x=bmi))+
  geom_histogram(color="darkblue", fill="lightblue")


```

```{r}
ols <- lm(bmi ~ H1GH51, data=w1_data)

library(stargazer)

stargazer(ols, type='text')
```

At a firts glance, it seems that bmi and ours of sleep are highly correlated. However, we must continue the investigation as several other cofounding factors can be at play here. First, we will see what is the effect of age in this, as we know age is an important factor in sleep

Age already plays a significant role in the regression.
